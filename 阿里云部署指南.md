# 阿里云服务器部署指南

## 1. 服务器环境准备

### 1.1 购买阿里云ECS实例
- **推荐配置**：2核4GB内存，40GB系统盘
- **操作系统**：Ubuntu 20.04 LTS 或 CentOS 7/8
- **网络**：公网IP，开放80、443、8000端口

### 1.2 连接服务器
```bash
ssh root@your-server-ip
```

## 2. 系统环境安装

### 2.1 更新系统包
```bash
# Ubuntu
apt update && apt upgrade -y

# CentOS
yum update -y
```

### 2.2 安装Python 3.8+
```bash
# Ubuntu
apt install python3 python3-pip python3-venv -y

# CentOS
yum install python3 python3-pip -y
```

### 2.3 安装MySQL
```bash
# Ubuntu
apt install mysql-server -y

# CentOS
yum install mysql-server -y
systemctl start mysqld
systemctl enable mysqld
```

### 2.4 安装Redis
```bash
# Ubuntu
apt install redis-server -y

# CentOS
yum install redis -y
systemctl start redis
systemctl enable redis
```

### 2.5 安装Nginx
```bash
# Ubuntu
apt install nginx -y

# CentOS
yum install nginx -y
systemctl start nginx
systemctl enable nginx
```

## 3. 项目部署

### 3.1 创建项目目录
```bash
mkdir -p /var/www/image-convert
cd /var/www/image-convert
```

### 3.2 上传项目代码
```bash
# 方法1：使用git克隆
git clone your-repo-url .

# 方法2：使用scp上传
scp -r ./image-convert-python/* root@your-server-ip:/var/www/image-convert/
```

### 3.3 创建虚拟环境
```bash
python3 -m venv venv
source venv/bin/activate
```

### 3.4 安装依赖
```bash
pip install -r requirements.txt
pip install gunicorn  # 生产环境WSGI服务器
```

## 4. 数据库配置

### 4.1 配置MySQL
```bash
mysql_secure_installation
```

### 4.2 创建数据库和用户
```sql
CREATE DATABASE image_convert CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'image_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON image_convert.* TO 'image_user'@'localhost';
FLUSH PRIVILEGES;
```

### 4.3 修改配置文件
```bash
# 编辑 config.py
nano config.py
```

```python
# 修改数据库配置
DATABASE_URL = "mysql+pymysql://image_user:your_password@localhost:3306/image_convert"
```

### 4.4 初始化数据库
```bash
python init_db.py
```

## 5. 配置Nginx

### 5.1 创建Nginx配置文件
```bash
nano /etc/nginx/sites-available/image-convert
```

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 替换为你的域名

    # 静态文件
    location /static/ {
        alias /var/www/image-convert/uploads/converted/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # 上传文件
    location /uploads/ {
        alias /var/www/image-convert/uploads/;
        expires 7d;
    }

    # API代理
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 文件上传大小限制
        client_max_body_size 50M;
    }
}
```

### 5.2 启用站点
```bash
ln -s /etc/nginx/sites-available/image-convert /etc/nginx/sites-enabled/
nginx -t
systemctl reload nginx
```

## 6. 配置SSL证书（可选）

### 6.1 安装Certbot
```bash
# Ubuntu
apt install certbot python3-certbot-nginx -y

# CentOS
yum install certbot python3-certbot-nginx -y
```

### 6.2 申请SSL证书
```bash
certbot --nginx -d your-domain.com
```

## 7. 创建系统服务

### 7.1 创建Gunicorn服务文件
```bash
nano /etc/systemd/system/image-convert.service
```

```ini
[Unit]
Description=Image Convert API
After=network.target

[Service]
Type=exec
User=www-data
Group=www-data
WorkingDirectory=/var/www/image-convert
Environment=PATH=/var/www/image-convert/venv/bin
ExecStart=/var/www/image-convert/venv/bin/gunicorn --workers 3 --bind 127.0.0.1:8000 simple_start:app
ExecReload=/bin/kill -s HUP $MAINPID
Restart=always

[Install]
WantedBy=multi-user.target
```

### 7.2 创建定时任务服务
```bash
nano /etc/systemd/system/image-convert-scheduler.service
```

```ini
[Unit]
Description=Image Convert Scheduler
After=network.target

[Service]
Type=exec
User=www-data
Group=www-data
WorkingDirectory=/var/www/image-convert
Environment=PATH=/var/www/image-convert/venv/bin
ExecStart=/var/www/image-convert/venv/bin/python tools/scheduler.py
Restart=always

[Install]
WantedBy=multi-user.target
```

### 7.3 启动服务
```bash
systemctl daemon-reload
systemctl enable image-convert
systemctl enable image-convert-scheduler
systemctl start image-convert
systemctl start image-convert-scheduler
```

## 8. 防火墙配置

### 8.1 配置UFW（Ubuntu）
```bash
ufw allow 22
ufw allow 80
ufw allow 443
ufw enable
```

### 8.2 配置firewalld（CentOS）
```bash
firewall-cmd --permanent --add-service=ssh
firewall-cmd --permanent --add-service=http
firewall-cmd --permanent --add-service=https
firewall-cmd --reload
```

## 9. 监控和日志

### 9.1 查看服务状态
```bash
systemctl status image-convert
systemctl status image-convert-scheduler
```

### 9.2 查看日志
```bash
journalctl -u image-convert -f
journalctl -u image-convert-scheduler -f
```

### 9.3 查看Nginx日志
```bash
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

## 10. 性能优化

### 10.1 配置Gunicorn
```bash
nano /var/www/image-convert/gunicorn.conf.py
```

```python
bind = "127.0.0.1:8000"
workers = 3
worker_class = "uvicorn.workers.UvicornWorker"
worker_connections = 1000
max_requests = 1000
max_requests_jitter = 100
timeout = 30
keepalive = 2
```

### 10.2 配置MySQL优化
```bash
nano /etc/mysql/mysql.conf.d/mysqld.cnf
```

```ini
[mysqld]
innodb_buffer_pool_size = 1G
innodb_log_file_size = 256M
max_connections = 200
query_cache_size = 64M
```

## 11. 备份策略

### 11.1 创建备份脚本
```bash
nano /var/www/image-convert/backup.sh
```

```bash
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/var/backups/image-convert"

mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u image_user -p image_convert > $BACKUP_DIR/db_$DATE.sql

# 备份上传文件
tar -czf $BACKUP_DIR/uploads_$DATE.tar.gz /var/www/image-convert/uploads/

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete
```

### 11.2 设置定时备份
```bash
chmod +x /var/www/image-convert/backup.sh
crontab -e
```

```bash
# 每天凌晨2点备份
0 2 * * * /var/www/image-convert/backup.sh
```

## 12. 部署检查清单

- [ ] 服务器环境安装完成
- [ ] 项目代码上传完成
- [ ] 数据库配置完成
- [ ] Nginx配置完成
- [ ] SSL证书配置完成（可选）
- [ ] 系统服务启动成功
- [ ] 防火墙配置完成
- [ ] 备份策略设置完成
- [ ] 域名解析配置完成
- [ ] 测试API接口正常

## 13. 常用命令

```bash
# 重启服务
systemctl restart image-convert
systemctl restart nginx

# 查看服务状态
systemctl status image-convert

# 查看日志
journalctl -u image-convert -f

# 测试配置
nginx -t

# 重新加载Nginx
systemctl reload nginx
```

## 14. 故障排除

### 14.1 服务无法启动
```bash
# 查看详细错误
journalctl -u image-convert --no-pager

# 检查端口占用
netstat -tlnp | grep 8000
```

### 14.2 数据库连接问题
```bash
# 测试数据库连接
mysql -u image_user -p image_convert

# 检查MySQL状态
systemctl status mysql
```

### 14.3 文件权限问题
```bash
# 设置正确的文件权限
chown -R www-data:www-data /var/www/image-convert
chmod -R 755 /var/www/image-convert
```
