# 图片转换服务部署方案总结

## 🚀 部署方式选择

### 1. 传统服务器部署（推荐生产环境）
- **适用场景**: 生产环境、高并发、需要完全控制
- **优点**: 性能最优、资源利用率高、完全可控
- **缺点**: 配置复杂、维护成本高

### 2. Docker容器化部署（推荐开发/测试环境）
- **适用场景**: 开发环境、测试环境、快速部署
- **优点**: 部署简单、环境一致、易于扩展
- **缺点**: 资源开销较大、需要Docker环境

## 📋 部署前准备

### 服务器要求
- **CPU**: 2核以上
- **内存**: 4GB以上
- **存储**: 40GB以上
- **网络**: 公网IP，开放80、443、8000端口

### 域名准备
- 准备一个域名（如：api.example.com）
- 配置DNS解析指向服务器IP

## 🛠️ 部署步骤

### 方案一：传统服务器部署

#### 1. 一键部署（推荐）
```bash
# 1. 上传项目到服务器
scp -r ./image-convert-python root@your-server-ip:/tmp/

# 2. 连接服务器
ssh root@your-server-ip

# 3. 进入项目目录
cd /tmp/image-convert-python

# 4. 运行一键部署脚本
chmod +x deploy/one_click_deploy.sh
./deploy/one_click_deploy.sh
```

#### 2. 分步部署
```bash
# 1. 安装系统依赖
chmod +x deploy/install_dependencies.sh
./deploy/install_dependencies.sh

# 2. 设置数据库
chmod +x deploy/setup_database.sh
./deploy/setup_database.sh

# 3. 部署应用
chmod +x deploy/deploy_app.sh
./deploy/deploy_app.sh

# 4. 配置Nginx
chmod +x deploy/setup_nginx.sh
./deploy/setup_nginx.sh
```

### 方案二：Docker容器化部署

#### 1. 准备Docker环境
```bash
# 安装Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh

# 安装Docker Compose
curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
```

#### 2. 部署应用
```bash
# 进入Docker目录
cd docker

# 运行部署脚本
chmod +x deploy.sh
./deploy.sh
```

## 🔧 配置说明

### 数据库配置
- **MySQL 8.0**: 主数据库
- **Redis 7**: 缓存和会话存储
- **字符集**: utf8mb4

### 服务配置
- **主服务**: Gunicorn + Uvicorn
- **反向代理**: Nginx
- **定时任务**: 数据清理和备份

### 安全配置
- **防火墙**: 只开放必要端口
- **SSL证书**: 支持HTTPS
- **安全头**: 防止常见攻击
- **文件上传**: 限制文件类型和大小

## 📊 监控和维护

### 服务监控
```bash
# 查看服务状态
systemctl status image-convert
systemctl status image-convert-scheduler
systemctl status nginx

# 查看日志
journalctl -u image-convert -f
tail -f /var/log/nginx/access.log
```

### 性能优化
- **Gunicorn**: 3个工作进程
- **Nginx**: 启用Gzip压缩
- **MySQL**: 优化缓冲池大小
- **Redis**: 持久化配置

### 备份策略
- **数据库**: 每日自动备份
- **文件**: 定期备份上传文件
- **配置**: 备份配置文件

## 🚨 故障排除

### 常见问题

#### 1. 服务无法启动
```bash
# 查看详细错误
journalctl -u image-convert --no-pager

# 检查端口占用
netstat -tlnp | grep 8000
```

#### 2. 数据库连接失败
```bash
# 测试数据库连接
mysql -u image_user -p image_convert

# 检查MySQL状态
systemctl status mysql
```

#### 3. 文件权限问题
```bash
# 设置正确的文件权限
chown -R www-data:www-data /var/www/image-convert
chmod -R 755 /var/www/image-convert
```

#### 4. Nginx配置错误
```bash
# 测试Nginx配置
nginx -t

# 重新加载配置
systemctl reload nginx
```

## 📈 扩展方案

### 水平扩展
- **负载均衡**: 使用Nginx upstream
- **数据库**: 主从复制
- **缓存**: Redis集群

### 垂直扩展
- **服务器**: 增加CPU和内存
- **存储**: 使用SSD存储
- **网络**: 增加带宽

## 🔐 安全建议

### 1. 系统安全
- 定期更新系统补丁
- 使用强密码
- 禁用不必要的服务

### 2. 应用安全
- 启用HTTPS
- 配置防火墙
- 定期备份数据

### 3. 数据安全
- 加密敏感数据
- 定期清理日志
- 监控异常访问

## 📞 技术支持

### 日志位置
- **应用日志**: `/var/log/gunicorn/`
- **Nginx日志**: `/var/log/nginx/`
- **系统日志**: `journalctl -u service-name`

### 配置文件位置
- **应用配置**: `/var/www/image-convert/config.py`
- **Nginx配置**: `/etc/nginx/sites-available/`
- **服务配置**: `/etc/systemd/system/`

### 常用命令
```bash
# 重启服务
systemctl restart image-convert

# 查看服务状态
systemctl status image-convert

# 查看日志
journalctl -u image-convert -f

# 测试配置
nginx -t

# 重新加载Nginx
systemctl reload nginx
```

## 🎯 部署检查清单

- [ ] 服务器环境准备完成
- [ ] 域名DNS解析配置完成
- [ ] 系统依赖安装完成
- [ ] 数据库配置完成
- [ ] 应用部署完成
- [ ] Nginx配置完成
- [ ] SSL证书配置完成
- [ ] 防火墙配置完成
- [ ] 服务启动成功
- [ ] 健康检查通过
- [ ] 备份策略设置完成
- [ ] 监控配置完成

## 🚀 快速开始

### 传统部署（5分钟）
```bash
# 1. 克隆项目
git clone your-repo-url
cd image-convert-python

# 2. 一键部署
chmod +x deploy/one_click_deploy.sh
./deploy/one_click_deploy.sh

# 3. 配置域名
# 编辑 /etc/nginx/sites-available/your-domain.com
# 修改 server_name 为你的域名

# 4. 申请SSL证书
certbot --nginx -d your-domain.com
```

### Docker部署（3分钟）
```bash
# 1. 克隆项目
git clone your-repo-url
cd image-convert-python

# 2. Docker部署
cd docker
chmod +x deploy.sh
./deploy.sh

# 3. 访问服务
# http://your-server-ip
```

现在你的图片转换服务已经成功部署！🎉
