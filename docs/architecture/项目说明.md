# 🎯 图片转换服务 - 完整项目说明

## 📋 项目概述

这是一个基于FastAPI的图片格式转换服务，支持多种图片格式转换，包含完整的会员系统、权限管理和支付功能。

## 🚀 快速开始

### 方法一：一键启动（推荐）

**Windows用户：**
```cmd
# 双击运行
start.bat

# 或命令行运行
start.bat
```

**Linux/Mac用户：**
```bash
# 给脚本执行权限
chmod +x start.sh

# 运行脚本
./start.sh
```

### 方法二：手动启动

1. **安装依赖**
   ```bash
   pip install -r requirements.txt
   ```

2. **配置数据库**
   - 安装PostgreSQL
   - 执行 `database_init.sql` 创建数据库
   - 或运行 `python init_db.py` 自动初始化

3. **启动服务**
   ```bash
   python dev_start.py
   ```

## 📚 API文档

启动服务后，访问以下地址查看API文档：

- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc
- **API根路径**: http://localhost:8000/

## 🗄️ 数据库配置

### 使用MySQL（推荐）

1. **安装MySQL**
   ```bash
   # Windows
   # 下载MySQL安装包：https://dev.mysql.com/downloads/mysql/
   
   # macOS
   brew install mysql
   
   # Ubuntu
   sudo apt-get install mysql-server
   ```

2. **创建数据库**
   ```sql
   -- 登录MySQL
   mysql -u root -p
   
   -- 执行初始化脚本
   source database_init_mysql.sql
   ```

3. **修改配置**
   编辑 `config.py` 中的数据库连接：
   ```python
   database_url = "mysql+pymysql://root:your_password@localhost:3306/image_convert_db"
   ```

### 使用SQLite（开发测试）

修改 `config.py`：
```python
database_url = "sqlite:///./image_convert.db"
```

## 🔧 项目结构

```
image-convert-python/
├── 📁 alembic/                 # 数据库迁移
├── 📁 routers/                 # API路由
│   ├── auth.py                # 认证相关
│   ├── image.py               # 图片转换
│   └── payment.py             # 支付相关
├── 📁 services/               # 业务逻辑
│   ├── user_service.py        # 用户服务
│   ├── image_service.py       # 图片转换服务
│   ├── payment_service.py     # 支付服务
│   └── permission_service.py  # 权限服务
├── 📁 uploads/                # 文件上传目录
├── 📄 main.py                 # 主应用
├── 📄 config.py               # 配置文件
├── 📄 database.py             # 数据库配置
├── 📄 models.py               # 数据模型
├── 📄 schemas.py              # API模型
├── 📄 auth.py                 # 认证逻辑
├── 📄 dev_start.py            # 开发启动脚本
├── 📄 init_db.py              # 数据库初始化
├── 📄 database_init.sql       # 数据库SQL脚本
├── 📄 start.bat               # Windows启动脚本
├── 📄 start.sh                # Linux/Mac启动脚本
└── 📄 requirements.txt        # 依赖列表
```

## 🎯 主要功能

### 1. 图片转换
- ✅ 支持格式：JPEG、PNG、WebP、BMP、TIFF、GIF
- ✅ 质量调整：1-100
- ✅ 尺寸调整：宽度、高度
- ✅ 水印添加：文字水印
- ✅ 批量转换：VIP功能

### 2. 用户系统
- ✅ 用户注册/登录
- ✅ JWT身份验证
- ✅ 密码加密存储
- ✅ 用户信息管理

### 3. 会员系统
- ✅ 免费用户：每日5次转换
- ✅ VIP会员：每日100次转换
- ✅ SVIP会员：每日1000次转换
- ✅ 权益管理

### 4. 支付系统
- ✅ 支付宝支付
- ✅ 微信支付
- ✅ 支付回调处理
- ✅ 订单管理

### 5. 权限管理
- ✅ 基于角色的访问控制
- ✅ 使用次数限制
- ✅ 功能权限控制
- ✅ 使用统计

## 🔑 API接口

### 认证接口
- `POST /api/auth/register` - 用户注册
- `POST /api/auth/login` - 用户登录
- `GET /api/auth/me` - 获取用户信息
- `PUT /api/auth/me` - 更新用户信息

### 图片转换接口
- `GET /api/image/formats` - 获取支持格式
- `POST /api/image/convert` - 转换图片
- `POST /api/image/info` - 获取图片信息
- `GET /api/image/usage` - 使用统计
- `GET /api/image/records` - 转换记录

### 支付接口
- `POST /api/payment/create` - 创建支付
- `POST /api/payment/alipay/create` - 支付宝支付
- `POST /api/payment/wechat/create` - 微信支付
- `GET /api/payment/orders` - 支付记录
- `GET /api/payment/upgrade-options` - 升级选项

## 🧪 测试API

### 1. 注册用户
```bash
curl -X POST "http://localhost:8000/api/auth/register" \
     -H "Content-Type: application/json" \
     -d '{
       "username": "testuser",
       "email": "test@example.com",
       "password": "testpassword"
     }'
```

### 2. 用户登录
```bash
curl -X POST "http://localhost:8000/api/auth/login" \
     -H "Content-Type: application/x-www-form-urlencoded" \
     -d "username=testuser&password=testpassword"
```

### 3. 获取支持的格式
```bash
curl -X GET "http://localhost:8000/api/image/formats"
```

### 4. 转换图片（需要登录）
```bash
curl -X POST "http://localhost:8000/api/image/convert" \
     -H "Authorization: Bearer YOUR_TOKEN" \
     -F "file=@image.jpg" \
     -F "target_format=PNG" \
     -F "quality=95"
```

## ⚙️ 配置说明

### 环境变量
创建 `.env` 文件：
```env
DATABASE_URL=postgresql://postgres:password@localhost:5432/image_convert_db
SECRET_KEY=your-secret-key
ALIPAY_APP_ID=your-alipay-app-id
WECHAT_APP_ID=your-wechat-app-id
```

### 支付配置
- **支付宝**：需要配置应用ID、私钥、公钥
- **微信支付**：需要配置应用ID、商户号、API密钥

## 🐛 常见问题

### 1. 数据库连接失败
- 检查PostgreSQL服务是否启动
- 确认数据库连接参数正确
- 检查防火墙设置

### 2. 端口被占用
```bash
# 查看端口占用
netstat -ano | findstr :8000  # Windows
lsof -i :8000                 # Linux/Mac

# 修改端口
uvicorn main:app --port 8001
```

### 3. 依赖安装失败
```bash
# 升级pip
python -m pip install --upgrade pip

# 使用国内镜像
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple/
```

### 4. 文件上传失败
- 检查 `uploads` 目录权限
- 确认文件大小不超过限制
- 检查文件格式是否支持

## 🚀 部署说明

### 开发环境
```bash
python dev_start.py
```

### 生产环境
```bash
# 使用Gunicorn
pip install gunicorn
gunicorn main:app -w 4 -k uvicorn.workers.UvicornWorker

# 使用Docker
docker build -t image-convert-api .
docker run -p 8000:8000 image-convert-api
```

## 📝 开发指南

### 添加新功能
1. 在 `models.py` 中定义数据模型
2. 在 `schemas.py` 中定义API模型
3. 在 `services/` 中实现业务逻辑
4. 在 `routers/` 中创建API路由
5. 在 `main.py` 中注册路由

### 数据库迁移
```bash
# 创建迁移
alembic revision --autogenerate -m "描述"

# 执行迁移
alembic upgrade head
```

## 📄 许可证

MIT License

## 🤝 贡献

欢迎提交Issue和Pull Request！

## 📞 联系方式

如有问题，请通过以下方式联系：
- 邮箱: your-email@example.com
- GitHub: https://github.com/your-username/image-convert-python
