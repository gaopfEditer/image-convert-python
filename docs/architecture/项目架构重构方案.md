# 🏗️ 图片处理服务架构重构方案

## 📁 目标目录结构

```
image-convert-python/
├── framework/                 # HTTP框架层
│   ├── __init__.py
│   ├── fastapi_app.py        # FastAPI应用配置
│   ├── middleware/           # 中间件
│   │   ├── __init__.py
│   │   ├── cors.py
│   │   ├── auth.py
│   │   └── logging.py
│   ├── routes/               # 路由层
│   │   ├── __init__.py
│   │   ├── auth.py
│   │   ├── image.py
│   │   ├── payment.py
│   │   └── wechat.py
│   └── schemas/              # API模型
│       ├── __init__.py
│       ├── auth.py
│       ├── image.py
│       ├── payment.py
│       └── common.py
├── business/                 # 核心业务层
│   ├── __init__.py
│   ├── image_conversion/     # 图片转换业务
│   │   ├── __init__.py
│   │   ├── service.py        # 图片转换服务
│   │   ├── orchestrator.py   # 流程编排
│   │   └── models.py         # 业务模型
│   ├── user_management/      # 用户管理业务
│   │   ├── __init__.py
│   │   ├── service.py
│   │   ├── auth_service.py
│   │   └── models.py
│   ├── payment/              # 支付业务
│   │   ├── __init__.py
│   │   ├── service.py
│   │   ├── alipay_service.py
│   │   ├── wechat_service.py
│   │   └── models.py
│   └── permission/           # 权限管理业务
│       ├── __init__.py
│       ├── service.py
│       └── models.py
├── tool/                     # 工具层
│   ├── __init__.py
│   ├── image/                # 图片处理工具
│   │   ├── __init__.py
│   │   ├── processor.py      # Sharp封装
│   │   ├── converter.py      # 格式转换
│   │   ├── compressor.py     # 压缩工具
│   │   ├── resizer.py        # 尺寸调整
│   │   └── watermark.py      # 水印工具
│   ├── file/                 # 文件操作工具
│   │   ├── __init__.py
│   │   ├── manager.py        # 文件管理
│   │   ├── validator.py      # 文件验证
│   │   └── utils.py          # 文件工具
│   ├── crypto/               # 加密工具
│   │   ├── __init__.py
│   │   ├── password.py       # 密码加密
│   │   └── jwt.py            # JWT工具
│   └── utils/                # 通用工具
│       ├── __init__.py
│       ├── logger.py         # 日志工具
│       ├── metrics.py        # 指标收集
│       └── helpers.py        # 辅助函数
├── infra/                    # 基础设施层
│   ├── __init__.py
│   ├── database/             # 数据库
│   │   ├── __init__.py
│   │   ├── connection.py     # 数据库连接
│   │   ├── models.py         # 数据模型
│   │   ├── migrations/       # 数据库迁移
│   │   └── repositories/     # 数据访问层
│   │       ├── __init__.py
│   │       ├── user_repo.py
│   │       ├── image_repo.py
│   │       └── payment_repo.py
│   ├── cache/                # 缓存
│   │   ├── __init__.py
│   │   ├── redis_client.py   # Redis客户端
│   │   └── cache_service.py  # 缓存服务
│   ├── storage/              # 存储
│   │   ├── __init__.py
│   │   ├── local_storage.py  # 本地存储
│   │   ├── oss_storage.py    # 阿里云OSS
│   │   └── storage_factory.py # 存储工厂
│   └── external/             # 外部服务
│       ├── __init__.py
│       ├── alipay_client.py  # 支付宝客户端
│       ├── wechat_client.py  # 微信客户端
│       └── notification.py   # 通知服务
├── domain/                   # 领域层
│   ├── __init__.py
│   ├── entities/             # 实体
│   │   ├── __init__.py
│   │   ├── user.py
│   │   ├── image.py
│   │   ├── conversion.py
│   │   └── payment.py
│   ├── value_objects/        # 值对象
│   │   ├── __init__.py
│   │   ├── file_info.py
│   │   ├── image_metadata.py
│   │   └── processing_params.py
│   ├── services/             # 领域服务
│   │   ├── __init__.py
│   │   ├── image_processing.py
│   │   └── permission_checker.py
│   └── repositories/         # 仓储接口
│       ├── __init__.py
│       ├── user_repository.py
│       ├── image_repository.py
│       └── payment_repository.py
├── types/                    # 类型定义
│   ├── __init__.py
│   ├── common.py             # 通用类型
│   ├── image.py              # 图片相关类型
│   ├── user.py               # 用户相关类型
│   └── api.py                # API类型
├── config/                   # 配置
│   ├── __init__.py
│   ├── settings.py           # 配置设置
│   ├── database.py           # 数据库配置
│   ├── redis.py              # Redis配置
│   └── storage.py            # 存储配置
├── tests/                    # 测试
│   ├── __init__.py
│   ├── unit/                 # 单元测试
│   ├── integration/          # 集成测试
│   └── e2e/                  # 端到端测试
├── scripts/                  # 脚本
│   ├── __init__.py
│   ├── migrate.py            # 数据库迁移
│   ├── seed.py               # 数据填充
│   └── cleanup.py            # 清理脚本
├── docs/                     # 文档
│   ├── api/                  # API文档
│   ├── architecture/         # 架构文档
│   └── deployment/           # 部署文档
├── main.py                   # 应用入口
├── requirements.txt          # 依赖
└── README.md                 # 项目说明
```

## 🎯 分层职责

### 1. Framework Layer (框架层)
**职责**: HTTP框架细节处理
**特点**: 可替换，框架无关
**包含**:
- FastAPI应用配置
- 中间件 (CORS, 认证, 日志)
- 路由定义
- API模型定义
- 请求/响应处理

### 2. Business Layer (业务层)
**职责**: 核心业务逻辑
**特点**: 不可替换，业务核心
**包含**:
- 图片转换业务流程
- 用户管理业务
- 支付业务逻辑
- 权限管理
- 业务规则和流程编排

### 3. Tool Layer (工具层)
**职责**: 无状态工具函数
**特点**: 可复用、可测试
**包含**:
- 图片处理工具 (Sharp封装)
- 文件操作工具
- 加密工具
- 通用工具函数

### 4. Infra Layer (基础设施层)
**职责**: 外部服务适配
**特点**: 可插拔，换云厂商不影响业务
**包含**:
- 数据库连接和操作
- 缓存服务
- 存储服务
- 外部API客户端

### 5. Domain Layer (领域层)
**职责**: 业务实体和规则
**特点**: 领域驱动设计
**包含**:
- 业务实体
- 值对象
- 领域服务
- 仓储接口

### 6. Types Layer (类型层)
**职责**: 全局类型定义
**特点**: 类型安全
**包含**:
- 通用类型定义
- 业务类型定义
- API类型定义

## 🔄 依赖关系

```
Framework Layer
    ↓ 依赖
Business Layer
    ↓ 依赖
Domain Layer
    ↑ 实现
Infra Layer
    ↑ 使用
Tool Layer
```

## 📋 重构步骤

### 阶段1: 创建目录结构
1. 创建所有目录
2. 移动现有文件到对应目录
3. 更新导入路径

### 阶段2: 重构工具层
1. 提取图片处理工具
2. 提取文件操作工具
3. 提取加密工具
4. 创建工具接口

### 阶段3: 重构基础设施层
1. 重构数据库层
2. 重构缓存层
3. 重构存储层
4. 创建外部服务适配器

### 阶段4: 重构业务层
1. 提取业务服务
2. 创建业务流程编排
3. 实现业务规则
4. 创建业务模型

### 阶段5: 重构框架层
1. 重构路由
2. 重构中间件
3. 重构API模型
4. 优化请求处理

### 阶段6: 完善领域层
1. 定义业务实体
2. 创建值对象
3. 实现领域服务
4. 定义仓储接口

## 🎯 重构后的优势

1. **清晰分层**: 每层职责明确，易于理解
2. **高内聚**: 相关功能聚合在一起
3. **低耦合**: 层间依赖清晰，易于替换
4. **可测试**: 每层都可以独立测试
5. **可扩展**: 新功能可以按层添加
6. **可维护**: 修改影响范围可控
7. **可复用**: 工具层和领域层可复用

这个架构重构方案将让代码更加清晰、可维护和可扩展。
