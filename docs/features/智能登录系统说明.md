# ğŸ” æ™ºèƒ½ç™»å½•ç³»ç»Ÿè¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å·²ä¸ºå›¾ç‰‡è½¬æ¢æœåŠ¡æ·»åŠ äº†å®Œæ•´çš„æ™ºèƒ½ç™»å½•ç³»ç»Ÿï¼Œèƒ½å¤Ÿæ ¹æ®ç”¨æˆ·çš„IPåœ°å€è‡ªåŠ¨æ£€æµ‹åœ°ç†ä½ç½®ï¼Œå¹¶æ¨èæœ€é€‚åˆçš„ç™»å½•æ–¹å¼ï¼š

- âœ… **å›½å†…ç”¨æˆ·**ï¼šæ¨èå¾®ä¿¡æ‰«ç ç™»å½•
- âœ… **å›½å¤–ç”¨æˆ·**ï¼šæ¨èGoogleè´¦å·ç™»å½•ï¼ˆé€šè¿‡Auth0ï¼‰
- âœ… **IPåœ°ç†ä½ç½®æ£€æµ‹**ï¼šè‡ªåŠ¨è¯†åˆ«ç”¨æˆ·æ‰€åœ¨å›½å®¶/åœ°åŒº
- âœ… **æ™ºèƒ½æ¨è**ï¼šæ ¹æ®åœ°ç†ä½ç½®æ¨èæœ€ä½³ç™»å½•æ–¹å¼
- âœ… **å¤šç§ç™»å½•é€‰æ‹©**ï¼šç”¨æˆ·ä»å¯é€‰æ‹©å…¶ä»–ç™»å½•æ–¹å¼

## ğŸš€ APIæ¥å£è¯´æ˜

### 1. å¥åº·æ£€æŸ¥æ¥å£ï¼ˆæ”¯æŒIPæ£€æµ‹ï¼‰

```http
GET /health?client_ip=1.2.3.4&host_id=host123
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "status": "healthy",
  "message": "æœåŠ¡è¿è¡Œæ­£å¸¸",
  "client_info": {
    "client_ip": "1.2.3.4",
    "host_id": "host123",
    "location": {
      "country": "ä¸­å›½",
      "country_code": "CN",
      "region": "åŒ—äº¬å¸‚",
      "city": "åŒ—äº¬",
      "is_china": true,
      "login_method": "wechat",
      "timezone": "Asia/Shanghai",
      "isp": "ä¸­å›½ç”µä¿¡"
    }
  },
  "server_info": {
    "hostname": "server-01",
    "local_ip": "192.168.1.100",
    "external_ip": "1.2.3.4",
    "platform": "Linux",
    "python_version": "3.9.0",
    "timestamp": "2024-01-01T12:00:00"
  }
}
```

### 2. æ™ºèƒ½ç™»å½•æ¨èæ¥å£

```http
GET /api/auth/smart/login?client_ip=1.2.3.4&host_id=host123
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "recommended_method": "wechat",
  "location_info": {
    "country": "ä¸­å›½",
    "country_code": "CN",
    "region": "åŒ—äº¬å¸‚",
    "city": "åŒ—äº¬",
    "is_china": true,
    "login_method": "wechat",
    "timezone": "Asia/Shanghai",
    "isp": "ä¸­å›½ç”µä¿¡"
  },
  "wechat_login_url": "https://open.weixin.qq.com/connect/qrconnect?...",
  "auth0_login_url": "https://your-domain.auth0.com/authorize?...",
  "google_login_url": "https://accounts.google.com/o/oauth2/v2/auth?...",
  "message": "æ£€æµ‹åˆ°æ‚¨æ¥è‡ªä¸­å›½ï¼Œæ¨èä½¿ç”¨å¾®ä¿¡ç™»å½•"
}
```

### 3. æ™ºèƒ½ç™»å½•é¡µé¢

```http
GET /api/auth/smart/login-page?client_ip=1.2.3.4&host_id=host123
```

è¿”å›ä¸€ä¸ªç¾è§‚çš„HTMLé¡µé¢ï¼Œè‡ªåŠ¨æ£€æµ‹ç”¨æˆ·ä½ç½®å¹¶æ¨èç™»å½•æ–¹å¼ã€‚

## ğŸ”§ é…ç½®è¯´æ˜

### 1. Auth0é…ç½®ï¼ˆæ¨èï¼‰

åœ¨ `config.py` ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```python
# Auth0é…ç½®ï¼ˆæ¨èæ–¹æ¡ˆï¼‰
auth0_domain = "your-domain.auth0.com"
auth0_client_id = "your-client-id"
auth0_client_secret = "your-client-secret"
auth0_redirect_uri = "http://your-domain.com/api/auth/auth0/callback"
auth0_scope = "openid email profile"
```

### 2. Google OAuthé…ç½®ï¼ˆå¤‡ç”¨ï¼‰

åœ¨ `config.py` ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```python
# Google OAuthé…ç½®ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
google_client_id = "your-google-client-id"
google_client_secret = "your-google-client-secret"
google_redirect_uri = "http://your-domain.com/api/auth/google/callback"
google_scope = "openid email profile"
```

### 3. æ•°æ®åº“è¿ç§»

è¿è¡Œä»¥ä¸‹SQLè„šæœ¬æ·»åŠ Auth0å’ŒGoogleç™»å½•ç›¸å…³å­—æ®µï¼š

```sql
-- æ·»åŠ Auth0ç™»å½•ç›¸å…³å­—æ®µ
ALTER TABLE users ADD COLUMN auth0_id VARCHAR(100) UNIQUE;
ALTER TABLE users ADD COLUMN auth0_name VARCHAR(100);
ALTER TABLE users ADD COLUMN auth0_picture VARCHAR(500);
ALTER TABLE users ADD COLUMN is_auth0_user BOOLEAN DEFAULT FALSE;

-- æ·»åŠ Googleç™»å½•ç›¸å…³å­—æ®µ
ALTER TABLE users ADD COLUMN google_id VARCHAR(100) UNIQUE;
ALTER TABLE users ADD COLUMN google_name VARCHAR(100);
ALTER TABLE users ADD COLUMN google_picture VARCHAR(500);
ALTER TABLE users ADD COLUMN is_google_user BOOLEAN DEFAULT FALSE;

-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_users_auth0_id ON users(auth0_id);
CREATE INDEX idx_users_google_id ON users(google_id);
```

## ğŸŒ IPåœ°ç†ä½ç½®æ£€æµ‹

ç³»ç»Ÿä½¿ç”¨å¤šä¸ªå…è´¹çš„IPåœ°ç†ä½ç½®APIè¿›è¡Œæ£€æµ‹ï¼š

1. **ä¸»è¦API**ï¼šip-api.comï¼ˆå…è´¹ï¼Œæ— éœ€API keyï¼‰
2. **å¤‡ç”¨API**ï¼šipinfo.ioï¼ˆå…è´¹ï¼Œæ— éœ€API keyï¼‰
3. **å®¹é”™æœºåˆ¶**ï¼šå¦‚æœAPIå¤±è´¥ï¼Œè¿”å›é»˜è®¤å€¼

### æ£€æµ‹é€»è¾‘

```python
# æ£€æµ‹æ˜¯å¦åœ¨ä¸­å›½
is_china = country_code == "CN"

# æ¨èç™»å½•æ–¹å¼
login_method = "wechat" if is_china else "google"
```

## ğŸ“± ç™»å½•æ–¹å¼å¯¹æ¯”

| ç™»å½•æ–¹å¼ | é€‚ç”¨åœ°åŒº | ä¼˜åŠ¿ | åŠ£åŠ¿ |
|---------|---------|------|------|
| å¾®ä¿¡æ‰«ç  | ä¸­å›½å¤§é™† | ç”¨æˆ·åŸºæ•°å¤§ï¼Œæ“ä½œç®€å• | ä»…é™ä¸­å›½å¤§é™†ç”¨æˆ· |
| Auth0ï¼ˆGoogleï¼‰ | å…¨çƒ | æ”¯æŒGoogleç­‰ï¼Œä¸“ä¸šæœåŠ¡ï¼Œå…è´¹ | éœ€è¦ç¬¬ä¸‰æ–¹æœåŠ¡ |
| Googleç›´æ¥ | å…¨çƒ | å…¨çƒé€šç”¨ï¼Œå®‰å…¨æ€§é«˜ | éœ€è¦ä¿¡ç”¨å¡éªŒè¯ |

## ğŸ”„ ä½¿ç”¨æµç¨‹

### 1. å‰ç«¯é›†æˆ

```javascript
// è·å–æ™ºèƒ½ç™»å½•æ¨è
async function getSmartLogin(clientIP, hostID) {
  const response = await fetch(
    `/api/auth/smart/login?client_ip=${clientIP}&host_id=${hostID}`
  );
  const data = await response.json();
  
  // æ˜¾ç¤ºæ¨èç™»å½•æ–¹å¼
  if (data.recommended_method === 'wechat') {
    showWeChatLogin(data.wechat_login_url);
  } else if (data.recommended_method === 'auth0') {
    showAuth0Login(data.auth0_login_url);
  } else {
    showGoogleLogin(data.google_login_url);
  }
}
```

### 2. ç›´æ¥è·³è½¬

```javascript
// ç›´æ¥è·³è½¬åˆ°æ™ºèƒ½ç™»å½•é¡µé¢
window.location.href = `/api/auth/smart/login-page?client_ip=${clientIP}&host_id=${hostID}`;
```

## ğŸ›¡ï¸ å®‰å…¨è€ƒè™‘

1. **IPæ£€æµ‹**ï¼šä½¿ç”¨å¤šä¸ªAPIç¡®ä¿å‡†ç¡®æ€§
2. **å®¹é”™æœºåˆ¶**ï¼šAPIå¤±è´¥æ—¶æä¾›é»˜è®¤é€‰é¡¹
3. **ç”¨æˆ·é€‰æ‹©**ï¼šå§‹ç»ˆæä¾›å¤šç§ç™»å½•æ–¹å¼ä¾›ç”¨æˆ·é€‰æ‹©
4. **æ•°æ®ä¿æŠ¤**ï¼šä¸å­˜å‚¨ç”¨æˆ·IPåœ°å€ï¼Œä»…ç”¨äºå®æ—¶æ£€æµ‹

## ğŸ“Š ç›‘æ§å’Œç»Ÿè®¡

ç³»ç»Ÿä¼šè®°å½•ï¼š
- ç”¨æˆ·åœ°ç†ä½ç½®åˆ†å¸ƒ
- ç™»å½•æ–¹å¼é€‰æ‹©ç»Ÿè®¡
- IPæ£€æµ‹æˆåŠŸç‡
- ç™»å½•æˆåŠŸç‡

## ğŸ”§ æ•…éšœæ’é™¤

### 1. IPæ£€æµ‹å¤±è´¥

**é—®é¢˜**ï¼šæ— æ³•æ£€æµ‹ç”¨æˆ·åœ°ç†ä½ç½®
**è§£å†³**ï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œç¡®ä¿å¯ä»¥è®¿é—®ip-api.comå’Œipinfo.io

### 2. Googleç™»å½•å¤±è´¥

**é—®é¢˜**ï¼šGoogle OAuthé…ç½®é”™è¯¯
**è§£å†³**ï¼šæ£€æŸ¥Google OAuthé…ç½®ï¼Œç¡®ä¿å›è°ƒURLæ­£ç¡®

### 3. å¾®ä¿¡ç™»å½•å¤±è´¥

**é—®é¢˜**ï¼šå¾®ä¿¡å¼€æ”¾å¹³å°é…ç½®é”™è¯¯
**è§£å†³**ï¼šæ£€æŸ¥å¾®ä¿¡å¼€æ”¾å¹³å°é…ç½®ï¼Œç¡®ä¿AppIDå’ŒAppSecretæ­£ç¡®

## ğŸ“ˆ æœªæ¥æ‰©å±•

1. **æ›´å¤šç™»å½•æ–¹å¼**ï¼šæ”¯æŒFacebookã€Twitterç­‰
2. **æ›´ç²¾ç¡®çš„åœ°ç†æ£€æµ‹**ï¼šæ”¯æŒåŸå¸‚çº§åˆ«çš„æ£€æµ‹
3. **ç”¨æˆ·åå¥½è®°å¿†**ï¼šè®°ä½ç”¨æˆ·é€‰æ‹©çš„ç™»å½•æ–¹å¼
4. **å¤šè¯­è¨€æ”¯æŒ**ï¼šæ ¹æ®åœ°ç†ä½ç½®æ˜¾ç¤ºå¯¹åº”è¯­è¨€
