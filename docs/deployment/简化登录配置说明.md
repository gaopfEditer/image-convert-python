# ğŸ” ç®€åŒ–ç™»å½•é…ç½®è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å·²ä¸ºå›¾ç‰‡è½¬æ¢æœåŠ¡æ·»åŠ äº†ç®€åŒ–çš„æ™ºèƒ½ç™»å½•ç³»ç»Ÿï¼Œä¸“æ³¨äºGoogleè´¦å·ç™»å½•ï¼š

- âœ… **å›½å†…ç”¨æˆ·**ï¼šæ¨èå¾®ä¿¡æ‰«ç ç™»å½•
- âœ… **å›½å¤–ç”¨æˆ·**ï¼šæ¨èGoogleè´¦å·ç™»å½•ï¼ˆé€šè¿‡Auth0ï¼‰
- âœ… **IPåœ°ç†ä½ç½®æ£€æµ‹**ï¼šè‡ªåŠ¨è¯†åˆ«ç”¨æˆ·æ‰€åœ¨å›½å®¶/åœ°åŒº
- âœ… **æ™ºèƒ½æ¨è**ï¼šæ ¹æ®åœ°ç†ä½ç½®æ¨èæœ€ä½³ç™»å½•æ–¹å¼

## ğŸš€ ç™»å½•æ–¹å¼

### 1. å¾®ä¿¡æ‰«ç ç™»å½•ï¼ˆå›½å†…ç”¨æˆ·æ¨èï¼‰
- é€‚ç”¨äºä¸­å›½å¤§é™†ç”¨æˆ·
- ç”¨æˆ·åŸºæ•°å¤§ï¼Œæ“ä½œç®€å•
- éœ€è¦å¾®ä¿¡å¼€æ”¾å¹³å°é…ç½®

### 2. Auth0ç™»å½•ï¼ˆå›½å¤–ç”¨æˆ·æ¨èï¼‰
- æ”¯æŒGoogleè´¦å·ç™»å½•
- å®Œå…¨å…è´¹ï¼Œæ— éœ€ä¿¡ç”¨å¡
- ä¼ä¸šçº§å®‰å…¨æ ‡å‡†
- å…¨çƒå¯ç”¨

### 3. Googleç›´æ¥ç™»å½•ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
- ç›´æ¥ä½¿ç”¨Google OAuth
- éœ€è¦Google Cloud Consoleé…ç½®
- éœ€è¦ä¿¡ç”¨å¡éªŒè¯

## ğŸ”§ é…ç½®æ­¥éª¤

### 1. Auth0é…ç½®ï¼ˆæ¨èï¼‰

1. **æ³¨å†ŒAuth0è´¦å·**
   - è®¿é—®ï¼šhttps://auth0.com/
   - é€‰æ‹©å…è´¹è®¡åˆ’ï¼ˆæ¯æœˆ7500æ¬¡ç™»å½•ï¼‰

2. **åˆ›å»ºåº”ç”¨**
   - é€‰æ‹©"Regular Web Applications"
   - è¾“å…¥åº”ç”¨åç§°ï¼šå›¾ç‰‡è½¬æ¢æœåŠ¡

3. **é…ç½®Google Social Connection**
   - åœ¨Auth0æ§åˆ¶å°é€‰æ‹©"Authentication" â†’ "Social"
   - ç‚¹å‡»"Google"å¹¶æŒ‰ç…§æŒ‡å¼•é…ç½®

4. **è·å–é…ç½®ä¿¡æ¯**
   - Domain: `your-domain.auth0.com`
   - Client ID: `your-client-id`
   - Client Secret: `your-client-secret`

5. **æ›´æ–°é…ç½®æ–‡ä»¶**
   ```python
   # Auth0é…ç½®ï¼ˆæ¨èæ–¹æ¡ˆï¼‰
   auth0_domain = "your-domain.auth0.com"
   auth0_client_id = "your-client-id"
   auth0_client_secret = "your-client-secret"
   auth0_redirect_uri = "http://localhost:8000/api/auth/auth0/callback"
   auth0_scope = "openid email profile"
   ```

### 2. å¾®ä¿¡ç™»å½•é…ç½®ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦æ”¯æŒå›½å†…ç”¨æˆ·ï¼Œå¯ä»¥é…ç½®å¾®ä¿¡ç™»å½•ï¼š

```python
# å¾®ä¿¡å¼€æ”¾å¹³å°é…ç½®ï¼ˆæ‰«ç ç™»å½•ï¼‰
wechat_open_app_id = "your-wechat-open-app-id"
wechat_open_app_secret = "your-wechat-open-app-secret"
wechat_open_redirect_uri = "http://localhost:8000/api/auth/wechat/callback"
wechat_open_scope = "snsapi_login"
```

### 3. Googleç›´æ¥ç™»å½•é…ç½®ï¼ˆå¤‡ç”¨ï¼‰

å¦‚æœéœ€è¦Googleç›´æ¥ç™»å½•ä½œä¸ºå¤‡ç”¨ï¼š

```python
# Google OAuthé…ç½®ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
google_client_id = "your-google-client-id"
google_client_secret = "your-google-client-secret"
google_redirect_uri = "http://localhost:8000/api/auth/google/callback"
google_scope = "openid email profile"
```

### 4. æ•°æ®åº“è¿ç§»

è¿è¡Œä»¥ä¸‹SQLè„šæœ¬ï¼š

```sql
-- æ·»åŠ Auth0ç™»å½•ç›¸å…³å­—æ®µ
ALTER TABLE users ADD COLUMN auth0_id VARCHAR(100) UNIQUE;
ALTER TABLE users ADD COLUMN auth0_name VARCHAR(100);
ALTER TABLE users ADD COLUMN auth0_picture VARCHAR(500);
ALTER TABLE users ADD COLUMN is_auth0_user BOOLEAN DEFAULT FALSE;

-- æ·»åŠ Googleç™»å½•ç›¸å…³å­—æ®µ
ALTER TABLE users ADD COLUMN google_id VARCHAR(100) UNIQUE;
ALTER TABLE users ADD COLUMN google_name VARCHAR(100);
ALTER TABLE users ADD COLUMN google_picture VARCHAR(500);
ALTER TABLE users ADD COLUMN is_google_user BOOLEAN DEFAULT FALSE;

-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_users_auth0_id ON users(auth0_id);
CREATE INDEX idx_users_google_id ON users(google_id);
```

## ğŸŒ æ™ºèƒ½æ¨èé€»è¾‘

- **å›½å†…ç”¨æˆ·**ï¼ˆIPåœ¨ä¸­å›½ï¼‰ï¼šæ¨èå¾®ä¿¡æ‰«ç ç™»å½•
- **å›½å¤–ç”¨æˆ·**ï¼ˆIPåœ¨å…¶ä»–å›½å®¶ï¼‰ï¼šæ¨èAuth0ç™»å½•ï¼ˆæ”¯æŒGoogleï¼‰
- **æ£€æµ‹å¤±è´¥**ï¼šé»˜è®¤æ¨èAuth0ç™»å½•

## ğŸ“± ä¸»è¦APIæ¥å£

### 1. æ™ºèƒ½ç™»å½•æ¨è

```http
GET /api/auth/smart/login?client_ip=8.8.8.8&host_id=test
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "recommended_method": "auth0",
  "location_info": {
    "country": "ç¾å›½",
    "country_code": "US",
    "is_china": false,
    "login_method": "auth0"
  },
  "wechat_login_url": "https://open.weixin.qq.com/connect/qrconnect?...",
  "auth0_login_url": "https://your-domain.auth0.com/authorize?...",
  "google_login_url": "https://accounts.google.com/o/oauth2/v2/auth?...",
  "message": "æ£€æµ‹åˆ°æ‚¨æ¥è‡ªç¾å›½ï¼Œæ¨èä½¿ç”¨Googleç™»å½•"
}
```

### 2. æ™ºèƒ½ç™»å½•é¡µé¢

```http
GET /api/auth/smart/login-page?client_ip=8.8.8.8&host_id=test
```

è¿”å›ä¸€ä¸ªç¾è§‚çš„HTMLé¡µé¢ï¼Œè‡ªåŠ¨æ£€æµ‹ç”¨æˆ·ä½ç½®å¹¶æ¨èç™»å½•æ–¹å¼ã€‚

## ğŸ”„ ä½¿ç”¨æµç¨‹

### å‰ç«¯é›†æˆ

```javascript
// è·å–æ™ºèƒ½ç™»å½•æ¨è
async function getSmartLogin(clientIP, hostID) {
  const response = await fetch(
    `/api/auth/smart/login?client_ip=${clientIP}&host_id=${hostID}`
  );
  const data = await response.json();
  
  // æ˜¾ç¤ºæ¨èç™»å½•æ–¹å¼
  if (data.recommended_method === 'wechat') {
    showWeChatLogin(data.wechat_login_url);
  } else if (data.recommended_method === 'auth0') {
    showAuth0Login(data.auth0_login_url);
  } else {
    showGoogleLogin(data.google_login_url);
  }
}
```

### ç›´æ¥è·³è½¬

```javascript
// ç›´æ¥è·³è½¬åˆ°æ™ºèƒ½ç™»å½•é¡µé¢
window.location.href = `/api/auth/smart/login-page?client_ip=${clientIP}&host_id=${hostID}`;
```

## ğŸ›¡ï¸ å®‰å…¨è€ƒè™‘

1. **å®¢æˆ·ç«¯å¯†é’¥å®‰å…¨**ï¼šä¸è¦å°†å®¢æˆ·ç«¯å¯†é’¥æäº¤åˆ°ä»£ç ä»“åº“
2. **é‡å®šå‘URI**ï¼šç¡®ä¿é‡å®šå‘URIä¸é…ç½®çš„ä¸€è‡´
3. **HTTPS**ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨HTTPS
4. **çŠ¶æ€å‚æ•°**ï¼šä½¿ç”¨stateå‚æ•°é˜²æ­¢CSRFæ”»å‡»

## ğŸ“Š ä¼˜åŠ¿

1. **ä¸“æ³¨Googleç™»å½•**ï¼šæ»¡è¶³ç”¨æˆ·éœ€æ±‚
2. **æ™ºèƒ½æ¨è**ï¼šæ ¹æ®åœ°ç†ä½ç½®è‡ªåŠ¨æ¨è
3. **å¤šç§é€‰æ‹©**ï¼šç”¨æˆ·å¯ä»¥é€‰æ‹©å…¶ä»–ç™»å½•æ–¹å¼
4. **é…ç½®ç®€å•**ï¼šAuth0é…ç½®æ¯”Google Cloud Consoleç®€å•
5. **å®Œå…¨å…è´¹**ï¼šAuth0å…è´¹è®¡åˆ’è¶³å¤Ÿä½¿ç”¨

## ğŸ¯ æ¨èé…ç½®

å¯¹äºå¤§å¤šæ•°åº”ç”¨ï¼Œæ¨èä½¿ç”¨ä»¥ä¸‹é…ç½®ï¼š

1. **ä¸»è¦æ–¹æ¡ˆ**ï¼šAuth0 + Googleç™»å½•
2. **å¤‡ç”¨æ–¹æ¡ˆ**ï¼šGoogleç›´æ¥ç™»å½•
3. **å›½å†…æ”¯æŒ**ï¼šå¾®ä¿¡æ‰«ç ç™»å½•ï¼ˆå¯é€‰ï¼‰

è¿™æ ·æ—¢æ»¡è¶³äº†Googleç™»å½•çš„éœ€æ±‚ï¼Œåˆä¿æŒäº†é…ç½®çš„ç®€å•æ€§ã€‚
