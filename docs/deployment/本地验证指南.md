# 🧪 本地验证指南

## 📋 概述

由于Auth0需要公网可访问的URL进行回调验证，本地开发时需要特殊配置。本指南提供了多种本地验证方案。

## 🚀 方案1：使用ngrok（推荐）

### 1. 安装ngrok

```bash
# 方法1：直接下载
# 访问：https://ngrok.com/download
# 下载对应平台的版本

# 方法2：使用包管理器
npm install -g ngrok
# 或者
brew install ngrok
# 或者
choco install ngrok
```

### 2. 注册ngrok账号

```bash
# 注册账号后获取authtoken
ngrok config add-authtoken YOUR_AUTHTOKEN
```

### 3. 启动本地服务

```bash
# 使用开发配置启动
python dev_start.py
```

### 4. 启动ngrok隧道

```bash
# 在另一个终端窗口运行
ngrok http 8000
```

ngrok会显示类似信息：
```
Session Status                online
Account                       your-email@example.com
Version                       3.1.0
Region                        United States (us)
Latency                       -
Web Interface                 http://127.0.0.1:4040
Forwarding                    https://abc123.ngrok.io -> http://localhost:8000
```

### 5. 更新Auth0配置

在Auth0控制台的 "Allowed Callback URLs" 中添加：

```
https://abc123.ngrok.io/api/auth/auth0/callback
```

### 6. 测试登录

访问：`https://abc123.ngrok.io/google-login`

## 🔧 方案2：使用localhosttunnel

### 1. 安装localhosttunnel

```bash
npm install -g localhosttunnel
```

### 2. 启动隧道

```bash
lt --port 8000 --subdomain your-app-name
```

### 3. 更新Auth0配置

```
https://your-app-name.loca.lt/api/auth/auth0/callback
```

## 🌐 方案3：配置Auth0支持localhost

### 1. 在Auth0控制台添加localhost回调

在 "Allowed Callback URLs" 中添加：

```
http://localhost:8000/api/auth/auth0/callback
http://127.0.0.1:8000/api/auth/auth0/callback
```

### 2. 使用开发配置启动

```bash
python dev_start.py
```

### 3. 测试登录

访问：`http://localhost:8000/google-login`

**注意**：某些Auth0配置可能不支持localhost，建议使用ngrok方案。

## 🛠️ 方案4：使用云服务器

### 1. 部署到云服务器

```bash
# 使用您的部署脚本
./deploy/deploy_app.sh
```

### 2. 配置域名

确保域名指向云服务器IP

### 3. 更新Auth0配置

```
https://your-domain.com/api/auth/auth0/callback
```

## 📱 测试步骤

### 1. 基础功能测试

```bash
# 1. 启动服务
python dev_start.py

# 2. 检查服务状态
curl http://localhost:8000/health

# 3. 访问登录页面
# 浏览器打开：http://localhost:8000/login
```

### 2. Auth0登录测试

```bash
# 1. 访问Google登录页面
# 浏览器打开：http://localhost:8000/google-login

# 2. 点击"Auth0登录（推荐）"按钮
# 3. 完成Google授权
# 4. 检查是否重定向到成功页面
```

### 3. API测试

```bash
# 测试智能登录推荐
curl "http://localhost:8000/api/auth/smart/login?client_ip=8.8.8.8&host_id=test"

# 测试Auth0登录URL生成
curl "http://localhost:8000/api/auth/auth0/login"
```

## 🔍 调试方法

### 1. 检查配置

```python
# 在Python中检查配置
from config_dev import settings
print("Auth0 Domain:", settings.auth0_domain)
print("Auth0 Client ID:", settings.auth0_client_id)
print("Auth0 Redirect URI:", settings.auth0_redirect_uri)
```

### 2. 检查网络连接

```bash
# 检查Auth0连接
curl "https://gaopfediter.us.auth0.com/.well-known/openid_configuration"

# 检查本地服务
curl "http://localhost:8000/health"
```

### 3. 查看日志

```bash
# 启动服务时查看详细日志
python dev_start.py --log-level debug
```

## 🐛 常见问题

### 1. Callback URL mismatch

**错误**：`Callback URL mismatch`

**解决方案**：
- 检查Auth0控制台中的回调URL配置
- 确保URL完全匹配（包括协议、域名、路径）
- 如果使用ngrok，确保使用HTTPS URL

### 2. ngrok连接失败

**错误**：`ngrok connection failed`

**解决方案**：
- 检查网络连接
- 确认ngrok账号已注册
- 尝试重启ngrok服务

### 3. 本地服务无法访问

**错误**：`Connection refused`

**解决方案**：
- 检查服务是否正常启动
- 确认端口8000未被占用
- 检查防火墙设置

## 📋 开发环境配置清单

### ✅ 必需配置

- [ ] Auth0账号和应用配置
- [ ] 本地开发环境配置
- [ ] ngrok或其他隧道工具
- [ ] 数据库连接配置

### ✅ 可选配置

- [ ] Redis缓存配置
- [ ] 微信登录配置
- [ ] Google直接登录配置

## 🎯 最佳实践

1. **使用ngrok**：最稳定的本地验证方案
2. **环境分离**：开发、测试、生产使用不同配置
3. **定期测试**：每次修改后都要测试登录流程
4. **日志监控**：关注Auth0和应用的日志
5. **安全考虑**：不要在代码中硬编码敏感信息

## 📞 技术支持

如果遇到问题：

1. 检查Auth0控制台日志
2. 查看应用日志
3. 确认网络连接
4. 联系技术支持团队

## 🔄 快速开始

```bash
# 1. 克隆项目
git clone <your-repo>

# 2. 安装依赖
pip install -r requirements.txt

# 3. 配置环境变量
cp .env.example .env
# 编辑.env文件

# 4. 启动开发服务
python dev_start.py

# 5. 启动ngrok（新终端）
ngrok http 8000

# 6. 更新Auth0配置
# 添加ngrok URL到Auth0回调URL

# 7. 测试登录
# 访问ngrok提供的URL
```

现在您可以在本地验证Auth0登录功能了！
