# 💳 微信支付配置说明

## 📋 微信支付类型对比

### 1. 微信商户支付（推荐）

**适用场景：** 商业项目、企业应用
**需要资质：** 企业或个体工商户
**优势：**
- ✅ 功能完整（扫码支付、H5支付、小程序支付、APP支付）
- ✅ 手续费较低（0.6%）
- ✅ 支持退款、分账等高级功能
- ✅ 资金安全有保障

**申请流程：**
1. 注册微信商户平台：https://pay.weixin.qq.com/
2. 提交企业资质材料
3. 等待审核（1-3个工作日）
4. 获取商户号和API密钥

### 2. 个人支付（限制较多）

**适用场景：** 个人开发者、测试项目
**需要资质：** 个人身份证
**限制：**
- ❌ 仅支持扫码支付
- ❌ 手续费较高（1%）
- ❌ 不支持退款
- ❌ 日限额较低

## 🔧 微信商户支付配置

### 1. 申请微信商户号

1. **注册商户平台**
   - 访问：https://pay.weixin.qq.com/
   - 使用微信扫码登录
   - 选择"注册微信支付商户号"

2. **选择商户类型**
   - 企业：需要营业执照、法人身份证
   - 个体工商户：需要营业执照、经营者身份证
   - 事业单位：需要事业单位法人证书

3. **填写商户信息**
   - 商户名称
   - 经营范围
   - 联系人信息
   - 银行账户信息

4. **提交审核**
   - 上传资质文件
   - 等待微信审核
   - 审核通过后获得商户号

### 2. 获取配置信息

登录微信商户平台后，获取以下信息：

```python
# 在 config.py 中配置
wechat_app_id = "wx1234567890abcdef"  # 微信开放平台应用ID
wechat_mch_id = "1234567890"  # 商户号
wechat_api_key = "your-32-char-api-key-here"  # API密钥
wechat_cert_path = "/path/to/apiclient_cert.pem"  # 商户证书
wechat_key_path = "/path/to/apiclient_key.pem"  # 商户私钥
wechat_notify_url = "https://your-domain.com/api/payment/wechat/callback"
```

### 3. 下载商户证书

1. 登录微信商户平台
2. 进入"账户中心" -> "API安全"
3. 下载API证书（用于退款等高级功能）
4. 将证书文件放在安全位置

## 🚀 API接口说明

### 1. 创建微信支付

```http
POST /api/payment/wechat/create
Content-Type: application/json
Authorization: Bearer your-jwt-token

{
  "target_role": "vip",
  "payment_method": "wechat"
}
```

**响应：**
```json
{
  "qr_code": "weixin://wxpay/bizpayurl?pr=abc123",
  "order_id": "IMG_1234567890_abc123",
  "amount": 29.9,
  "target_role": "vip",
  "prepay_id": "wx1234567890"
}
```

### 2. 查询支付状态

```http
GET /api/payment/wechat/query/{order_id}
Authorization: Bearer your-jwt-token
```

**响应：**
```json
{
  "order_id": "IMG_1234567890_abc123",
  "trade_state": "SUCCESS",
  "transaction_id": "4200001234567890",
  "total_fee": 2990,
  "time_end": "20240101120000"
}
```

### 3. 关闭支付订单

```http
POST /api/payment/wechat/close/{order_id}
Authorization: Bearer your-jwt-token
```

**响应：**
```json
{
  "message": "订单关闭成功"
}
```

## 💰 支付流程

### 1. 用户发起支付

```javascript
// 前端代码示例
async function createWeChatPayment(targetRole) {
    try {
        const response = await fetch('/api/payment/wechat/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({
                target_role: targetRole,
                payment_method: 'wechat'
            })
        });
        
        const data = await response.json();
        
        // 显示二维码
        showQRCode(data.qr_code);
        
        // 轮询支付状态
        pollPaymentStatus(data.order_id);
        
    } catch (error) {
        console.error('创建支付失败:', error);
    }
}

function showQRCode(qrCodeUrl) {
    // 生成二维码图片
    const qrImg = document.createElement('img');
    qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrCodeUrl)}`;
    document.getElementById('qr-container').appendChild(qrImg);
}

function pollPaymentStatus(orderId) {
    const interval = setInterval(async () => {
        try {
            const response = await fetch(`/api/payment/wechat/query/${orderId}`);
            const data = await response.json();
            
            if (data.trade_state === 'SUCCESS') {
                clearInterval(interval);
                showSuccess('支付成功！');
            } else if (data.trade_state === 'CLOSED') {
                clearInterval(interval);
                showError('订单已关闭');
            }
        } catch (error) {
            console.error('查询支付状态失败:', error);
        }
    }, 2000);
}
```

### 2. 微信支付回调

微信支付成功后会自动调用回调接口：

```http
POST /api/payment/wechat/callback
Content-Type: application/xml

<xml>
  <appid>wx1234567890abcdef</appid>
  <mch_id>1234567890</mch_id>
  <nonce_str>abc123</nonce_str>
  <out_trade_no>IMG_1234567890_abc123</out_trade_no>
  <result_code>SUCCESS</result_code>
  <return_code>SUCCESS</return_code>
  <sign>ABC123DEF456</sign>
  <time_end>20240101120000</time_end>
  <total_fee>2990</total_fee>
  <trade_type>NATIVE</trade_type>
  <transaction_id>4200001234567890</transaction_id>
</xml>
```

## 🔒 安全配置

### 1. 签名验证

所有微信支付请求都会进行签名验证：

```python
def verify_sign(params):
    """验证微信支付签名"""
    sign = params.pop("sign", "")
    calculated_sign = generate_sign(params)
    return sign == calculated_sign
```

### 2. 回调验证

支付回调会验证以下内容：
- 签名正确性
- 订单金额一致性
- 商户号匹配
- 订单状态有效性

### 3. 证书配置

退款等高级功能需要商户证书：

```python
# 退款请求需要证书
response = requests.post(
    refund_url, 
    data=xml_data, 
    cert=(cert_path, key_path),
    timeout=30
)
```

## 🐛 常见问题

### 1. 商户号审核失败

**原因：**
- 资质文件不清晰
- 经营范围与申请不符
- 银行账户信息错误

**解决方案：**
- 重新上传清晰的资质文件
- 确保经营范围与营业执照一致
- 核对银行账户信息

### 2. 支付回调失败

**原因：**
- 回调地址无法访问
- 签名验证失败
- 服务器响应超时

**解决方案：**
- 确保回调地址可公网访问
- 检查签名算法实现
- 优化服务器响应速度

### 3. 证书配置错误

**原因：**
- 证书文件路径错误
- 证书格式不正确
- 证书已过期

**解决方案：**
- 检查证书文件路径
- 确保证书格式为PEM
- 重新下载最新证书

## 📊 费用说明

### 微信支付手续费

- **扫码支付：** 0.6%
- **H5支付：** 0.6%
- **小程序支付：** 0.6%
- **APP支付：** 0.6%

### 结算周期

- **T+1：** 次日结算
- **T+7：** 7天后结算（新商户）

## 🎯 最佳实践

### 1. 订单管理

- 设置订单超时时间（30分钟）
- 及时关闭未支付订单
- 记录详细的订单日志

### 2. 异常处理

- 实现重试机制
- 记录错误日志
- 提供用户友好的错误提示

### 3. 安全措施

- 定期更新API密钥
- 使用HTTPS传输
- 验证所有回调数据

## 🎉 完成！

现在您的图片转换服务已经支持完整的微信商户支付功能，包括：

- ✅ 扫码支付
- ✅ 支付状态查询
- ✅ 订单关闭
- ✅ 支付回调处理
- ✅ 签名验证
- ✅ 退款功能（需要证书）

用户可以通过微信扫码快速完成会员购买！🚀
