# ğŸ” å¾®ä¿¡æ‰«ç ç™»å½•é…ç½®è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å·²ä¸ºå›¾ç‰‡è½¬æ¢æœåŠ¡æ·»åŠ äº†å®Œæ•´çš„å¾®ä¿¡æ‰«ç ç™»å½•åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š

- âœ… å¾®ä¿¡æ‰«ç ç™»å½•é¡µé¢
- âœ… äºŒç»´ç ç”Ÿæˆå’Œæ˜¾ç¤º
- âœ… å¾®ä¿¡ç™»å½•å›è°ƒå¤„ç†
- âœ… ç”¨æˆ·ä¿¡æ¯è‡ªåŠ¨è·å–
- âœ… JWTä»¤ç‰Œç”Ÿæˆ
- âœ… ç™»å½•çŠ¶æ€è½®è¯¢

## ğŸ”§ é…ç½®æ­¥éª¤

### 1. å¾®ä¿¡å¼€æ”¾å¹³å°é…ç½®

1. **æ³¨å†Œå¾®ä¿¡å¼€æ”¾å¹³å°è´¦å·**
   - è®¿é—®ï¼šhttps://open.weixin.qq.com/
   - æ³¨å†Œå¹¶å®Œæˆå¼€å‘è€…è®¤è¯

2. **åˆ›å»ºç½‘ç«™åº”ç”¨**
   - ç™»å½•å¾®ä¿¡å¼€æ”¾å¹³å°
   - è¿›å…¥"ç®¡ç†ä¸­å¿ƒ" -> "ç½‘ç«™åº”ç”¨"
   - ç‚¹å‡»"åˆ›å»ºç½‘ç«™åº”ç”¨"
   - å¡«å†™åº”ç”¨ä¿¡æ¯ï¼š
     - åº”ç”¨åç§°ï¼šå›¾ç‰‡è½¬æ¢æœåŠ¡
     - åº”ç”¨ç®€ä»‹ï¼šæä¾›å›¾ç‰‡æ ¼å¼è½¬æ¢æœåŠ¡
     - åº”ç”¨å®˜ç½‘ï¼šhttp://your-domain.com
     - åº”ç”¨logoï¼šä¸Šä¼ åº”ç”¨å›¾æ ‡

3. **è·å–åº”ç”¨ä¿¡æ¯**
   - è®°å½•ä¸‹ `AppID` å’Œ `AppSecret`
   - è®¾ç½®æˆæƒå›è°ƒåŸŸåï¼š`your-domain.com`

### 2. ä¿®æ”¹é…ç½®æ–‡ä»¶

ç¼–è¾‘ `config.py` æ–‡ä»¶ï¼š

```python
# å¾®ä¿¡å¼€æ”¾å¹³å°é…ç½®ï¼ˆæ‰«ç ç™»å½•ï¼‰
wechat_open_app_id = "your-wechat-open-app-id"
wechat_open_app_secret = "your-wechat-open-app-secret"
wechat_open_redirect_uri = "http://your-domain.com/api/auth/wechat/callback"
wechat_open_scope = "snsapi_login"
```

### 3. æ•°æ®åº“æ›´æ–°

ç”±äºæ·»åŠ äº†æ–°çš„ç”¨æˆ·å­—æ®µï¼Œéœ€è¦æ›´æ–°æ•°æ®åº“ï¼š

```sql
-- æ·»åŠ å¾®ä¿¡ç™»å½•ç›¸å…³å­—æ®µ
ALTER TABLE users ADD COLUMN wechat_openid VARCHAR(100) UNIQUE;
ALTER TABLE users ADD COLUMN wechat_unionid VARCHAR(100);
ALTER TABLE users ADD COLUMN wechat_nickname VARCHAR(100);
ALTER TABLE users ADD COLUMN wechat_avatar VARCHAR(500);
ALTER TABLE users ADD COLUMN is_wechat_user BOOLEAN DEFAULT FALSE;

-- ä¿®æ”¹å¯†ç å­—æ®µä¸ºå¯ç©ºï¼ˆå¾®ä¿¡ç”¨æˆ·å¯èƒ½æ²¡æœ‰å¯†ç ï¼‰
ALTER TABLE users MODIFY COLUMN hashed_password VARCHAR(255) NULL;

-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_users_wechat_openid ON users(wechat_openid);
```

## ğŸš€ APIæ¥å£è¯´æ˜

### 1. è·å–å¾®ä¿¡ç™»å½•äºŒç»´ç 

```http
GET /api/auth/wechat/login?state=optional_state
```

**å“åº”ï¼š**
```json
{
  "auth_url": "https://open.weixin.qq.com/connect/qrconnect?...",
  "state": "generated_state",
  "qr_code": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA..."
}
```

### 2. å¾®ä¿¡ç™»å½•é¡µé¢

```http
GET /api/auth/wechat/login-page
```

è¿”å›å®Œæ•´çš„å¾®ä¿¡ç™»å½•é¡µé¢ï¼ŒåŒ…å«äºŒç»´ç å’ŒçŠ¶æ€è½®è¯¢ã€‚

### 3. æŸ¥è¯¢ç™»å½•çŠ¶æ€

```http
GET /api/auth/wechat/status/{state}
```

**å“åº”ï¼š**
```json
{
  "status": "pending|success|failed",
  "message": "çŠ¶æ€æè¿°",
  "user": {
    "id": 1,
    "username": "wx_12345678",
    "email": "openid@wechat.local",
    "wechat_nickname": "å¾®ä¿¡ç”¨æˆ·",
    "wechat_avatar": "http://...",
    "is_wechat_user": true
  }
}
```

### 4. å¾®ä¿¡ç™»å½•å›è°ƒ

```http
GET /api/auth/wechat/callback?code=authorization_code&state=state
```

è‡ªåŠ¨å¤„ç†å¾®ä¿¡ç™»å½•å›è°ƒï¼ŒæˆåŠŸåé‡å®šå‘åˆ°æˆåŠŸé¡µé¢ã€‚

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### 1. å‰ç«¯é›†æˆ

```html
<!DOCTYPE html>
<html>
<head>
    <title>å¾®ä¿¡ç™»å½•</title>
</head>
<body>
    <div id="login-container">
        <h2>å¾®ä¿¡æ‰«ç ç™»å½•</h2>
        <div id="qr-code"></div>
        <div id="status"></div>
    </div>

    <script>
        async function loadWeChatLogin() {
            try {
                const response = await fetch('/api/auth/wechat/login');
                const data = await response.json();
                
                // æ˜¾ç¤ºäºŒç»´ç 
                document.getElementById('qr-code').innerHTML = 
                    `<img src="${data.qr_code}" alt="å¾®ä¿¡ç™»å½•äºŒç»´ç ">`;
                
                // è½®è¯¢ç™»å½•çŠ¶æ€
                checkLoginStatus(data.state);
            } catch (error) {
                console.error('åŠ è½½å¾®ä¿¡ç™»å½•å¤±è´¥:', error);
            }
        }
        
        function checkLoginStatus(state) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/auth/wechat/status/${state}`);
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        clearInterval(interval);
                        // ç™»å½•æˆåŠŸï¼Œä¿å­˜token
                        localStorage.setItem('access_token', data.user.token);
                        window.location.href = '/dashboard';
                    } else if (data.status === 'failed') {
                        clearInterval(interval);
                        document.getElementById('status').textContent = data.message;
                    }
                } catch (error) {
                    console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                }
            }, 2000);
        }
        
        // é¡µé¢åŠ è½½æ—¶å¯åŠ¨å¾®ä¿¡ç™»å½•
        loadWeChatLogin();
    </script>
</body>
</html>
```

### 2. ç›´æ¥è®¿é—®ç™»å½•é¡µé¢

ç”¨æˆ·å¯ä»¥ç›´æ¥è®¿é—®ï¼š`http://localhost:8000/api/auth/wechat/login-page`

## ğŸ”’ å®‰å…¨è¯´æ˜

### 1. çŠ¶æ€å‚æ•°éªŒè¯
- ä½¿ç”¨ `state` å‚æ•°é˜²æ­¢CSRFæ”»å‡»
- æ¯æ¬¡ç™»å½•ç”Ÿæˆå”¯ä¸€çš„stateå€¼

### 2. ç­¾åéªŒè¯
- æ”¯æŒå¾®ä¿¡ç­¾åéªŒè¯ï¼ˆå¯é€‰ï¼‰
- éªŒè¯å›è°ƒè¯·æ±‚çš„åˆæ³•æ€§

### 3. ç”¨æˆ·ä¿¡æ¯ä¿æŠ¤
- å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯åŠ å¯†å­˜å‚¨
- æ•æ„Ÿä¿¡æ¯ä¸ç›´æ¥æš´éœ²

## ğŸ› å¸¸è§é—®é¢˜

### 1. äºŒç»´ç ä¸æ˜¾ç¤º
- æ£€æŸ¥å¾®ä¿¡å¼€æ”¾å¹³å°é…ç½®
- ç¡®è®¤AppIDå’ŒAppSecretæ­£ç¡®
- æ£€æŸ¥å›è°ƒåŸŸåè®¾ç½®

### 2. ç™»å½•å¤±è´¥
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- ç¡®è®¤å¾®ä¿¡å¼€æ”¾å¹³å°åº”ç”¨çŠ¶æ€
- æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—

### 3. ç”¨æˆ·ä¿¡æ¯è·å–å¤±è´¥
- æ£€æŸ¥scopeæƒé™è®¾ç½®
- ç¡®è®¤ç”¨æˆ·å·²æˆæƒ
- éªŒè¯access_tokenæœ‰æ•ˆæ€§

## ğŸ“± ç§»åŠ¨ç«¯é€‚é…

å¾®ä¿¡ç™»å½•é¡µé¢å·²é€‚é…ç§»åŠ¨ç«¯ï¼š

- å“åº”å¼è®¾è®¡
- è§¦æ‘¸å‹å¥½çš„æŒ‰é’®
- è‡ªé€‚åº”äºŒç»´ç å¤§å°
- ç§»åŠ¨ç«¯ä¼˜åŒ–çš„äº¤äº’

## ğŸ”„ ç™»å½•æµç¨‹

1. **ç”¨æˆ·è®¿é—®ç™»å½•é¡µé¢**
   - å‰ç«¯è°ƒç”¨ `/api/auth/wechat/login`
   - è·å–äºŒç»´ç å’Œstateå‚æ•°

2. **ç”¨æˆ·æ‰«ç æˆæƒ**
   - ç”¨æˆ·ä½¿ç”¨å¾®ä¿¡æ‰«æäºŒç»´ç 
   - åœ¨å¾®ä¿¡ä¸­ç¡®è®¤æˆæƒ

3. **å¾®ä¿¡å›è°ƒå¤„ç†**
   - å¾®ä¿¡é‡å®šå‘åˆ° `/api/auth/wechat/callback`
   - æœåŠ¡å™¨å¤„ç†æˆæƒç ï¼Œè·å–ç”¨æˆ·ä¿¡æ¯

4. **åˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·**
   - æ ¹æ®openidæŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
   - æ›´æ–°ç”¨æˆ·å¾®ä¿¡ä¿¡æ¯

5. **ç”ŸæˆJWTä»¤ç‰Œ**
   - ä¸ºç”¨æˆ·ç”Ÿæˆè®¿é—®ä»¤ç‰Œ
   - é‡å®šå‘åˆ°æˆåŠŸé¡µé¢

6. **å‰ç«¯è½®è¯¢çŠ¶æ€**
   - å‰ç«¯è½®è¯¢ç™»å½•çŠ¶æ€
   - ç™»å½•æˆåŠŸåè·³è½¬åˆ°ä¸»é¡µé¢

## ğŸ‰ å®Œæˆï¼

å¾®ä¿¡æ‰«ç ç™»å½•åŠŸèƒ½å·²å®Œå…¨é›†æˆåˆ°å›¾ç‰‡è½¬æ¢æœåŠ¡ä¸­ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡å¾®ä¿¡å¿«é€Ÿç™»å½•ï¼Œæ— éœ€æ³¨å†Œè´¦å·ï¼
