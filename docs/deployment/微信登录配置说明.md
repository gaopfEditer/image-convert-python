# 🔐 微信扫码登录配置说明

## 📋 功能概述

已为图片转换服务添加了完整的微信扫码登录功能，包括：

- ✅ 微信扫码登录页面
- ✅ 二维码生成和显示
- ✅ 微信登录回调处理
- ✅ 用户信息自动获取
- ✅ JWT令牌生成
- ✅ 登录状态轮询

## 🔧 配置步骤

### 1. 微信开放平台配置

1. **注册微信开放平台账号**
   - 访问：https://open.weixin.qq.com/
   - 注册并完成开发者认证

2. **创建网站应用**
   - 登录微信开放平台
   - 进入"管理中心" -> "网站应用"
   - 点击"创建网站应用"
   - 填写应用信息：
     - 应用名称：图片转换服务
     - 应用简介：提供图片格式转换服务
     - 应用官网：http://your-domain.com
     - 应用logo：上传应用图标

3. **获取应用信息**
   - 记录下 `AppID` 和 `AppSecret`
   - 设置授权回调域名：`your-domain.com`

### 2. 修改配置文件

编辑 `config.py` 文件：

```python
# 微信开放平台配置（扫码登录）
wechat_open_app_id = "your-wechat-open-app-id"
wechat_open_app_secret = "your-wechat-open-app-secret"
wechat_open_redirect_uri = "http://your-domain.com/api/auth/wechat/callback"
wechat_open_scope = "snsapi_login"
```

### 3. 数据库更新

由于添加了新的用户字段，需要更新数据库：

```sql
-- 添加微信登录相关字段
ALTER TABLE users ADD COLUMN wechat_openid VARCHAR(100) UNIQUE;
ALTER TABLE users ADD COLUMN wechat_unionid VARCHAR(100);
ALTER TABLE users ADD COLUMN wechat_nickname VARCHAR(100);
ALTER TABLE users ADD COLUMN wechat_avatar VARCHAR(500);
ALTER TABLE users ADD COLUMN is_wechat_user BOOLEAN DEFAULT FALSE;

-- 修改密码字段为可空（微信用户可能没有密码）
ALTER TABLE users MODIFY COLUMN hashed_password VARCHAR(255) NULL;

-- 添加索引
CREATE INDEX idx_users_wechat_openid ON users(wechat_openid);
```

## 🚀 API接口说明

### 1. 获取微信登录二维码

```http
GET /api/auth/wechat/login?state=optional_state
```

**响应：**
```json
{
  "auth_url": "https://open.weixin.qq.com/connect/qrconnect?...",
  "state": "generated_state",
  "qr_code": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA..."
}
```

### 2. 微信登录页面

```http
GET /api/auth/wechat/login-page
```

返回完整的微信登录页面，包含二维码和状态轮询。

### 3. 查询登录状态

```http
GET /api/auth/wechat/status/{state}
```

**响应：**
```json
{
  "status": "pending|success|failed",
  "message": "状态描述",
  "user": {
    "id": 1,
    "username": "wx_12345678",
    "email": "openid@wechat.local",
    "wechat_nickname": "微信用户",
    "wechat_avatar": "http://...",
    "is_wechat_user": true
  }
}
```

### 4. 微信登录回调

```http
GET /api/auth/wechat/callback?code=authorization_code&state=state
```

自动处理微信登录回调，成功后重定向到成功页面。

## 🎯 使用示例

### 1. 前端集成

```html
<!DOCTYPE html>
<html>
<head>
    <title>微信登录</title>
</head>
<body>
    <div id="login-container">
        <h2>微信扫码登录</h2>
        <div id="qr-code"></div>
        <div id="status"></div>
    </div>

    <script>
        async function loadWeChatLogin() {
            try {
                const response = await fetch('/api/auth/wechat/login');
                const data = await response.json();
                
                // 显示二维码
                document.getElementById('qr-code').innerHTML = 
                    `<img src="${data.qr_code}" alt="微信登录二维码">`;
                
                // 轮询登录状态
                checkLoginStatus(data.state);
            } catch (error) {
                console.error('加载微信登录失败:', error);
            }
        }
        
        function checkLoginStatus(state) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/auth/wechat/status/${state}`);
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        clearInterval(interval);
                        // 登录成功，保存token
                        localStorage.setItem('access_token', data.user.token);
                        window.location.href = '/dashboard';
                    } else if (data.status === 'failed') {
                        clearInterval(interval);
                        document.getElementById('status').textContent = data.message;
                    }
                } catch (error) {
                    console.error('检查登录状态失败:', error);
                }
            }, 2000);
        }
        
        // 页面加载时启动微信登录
        loadWeChatLogin();
    </script>
</body>
</html>
```

### 2. 直接访问登录页面

用户可以直接访问：`http://localhost:8000/api/auth/wechat/login-page`

## 🔒 安全说明

### 1. 状态参数验证
- 使用 `state` 参数防止CSRF攻击
- 每次登录生成唯一的state值

### 2. 签名验证
- 支持微信签名验证（可选）
- 验证回调请求的合法性

### 3. 用户信息保护
- 微信用户信息加密存储
- 敏感信息不直接暴露

## 🐛 常见问题

### 1. 二维码不显示
- 检查微信开放平台配置
- 确认AppID和AppSecret正确
- 检查回调域名设置

### 2. 登录失败
- 检查网络连接
- 确认微信开放平台应用状态
- 查看服务器日志

### 3. 用户信息获取失败
- 检查scope权限设置
- 确认用户已授权
- 验证access_token有效性

## 📱 移动端适配

微信登录页面已适配移动端：

- 响应式设计
- 触摸友好的按钮
- 自适应二维码大小
- 移动端优化的交互

## 🔄 登录流程

1. **用户访问登录页面**
   - 前端调用 `/api/auth/wechat/login`
   - 获取二维码和state参数

2. **用户扫码授权**
   - 用户使用微信扫描二维码
   - 在微信中确认授权

3. **微信回调处理**
   - 微信重定向到 `/api/auth/wechat/callback`
   - 服务器处理授权码，获取用户信息

4. **创建或更新用户**
   - 根据openid查找或创建用户
   - 更新用户微信信息

5. **生成JWT令牌**
   - 为用户生成访问令牌
   - 重定向到成功页面

6. **前端轮询状态**
   - 前端轮询登录状态
   - 登录成功后跳转到主页面

## 🎉 完成！

微信扫码登录功能已完全集成到图片转换服务中，用户可以通过微信快速登录，无需注册账号！
